# 工作流名称（随便取，方便识别）
name: Build and Deploy to Aliyun

# 触发条件：只有推送到 main 分支时才运行
on:
  push:
    branches: [ main ]

# 任务集合
jobs:
  # 单个任务，命名为 deploy
  deploy:
    # 运行环境：GitHub 提供的 Ubuntu 最新版
    runs-on: ubuntu-latest
    
    # 任务步骤
    steps:
      # 步骤1：拉取 GitHub 仓库里的代码到运行环境
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：安装 Node.js（VitePress 打包需要）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18  # Node 版本选 18，兼容绝大多数 VitePress 版本
          cache: 'npm'      # 缓存 npm 依赖，加速下次运行

      # 步骤3：安装项目依赖（npm install）
      - name: Install dependencies
        run: npm install

      # 步骤4：打包 VitePress 项目（生成静态文件）
      - name: Build VitePress
        run: npm run docs:build  # 确保这是你本地正确的打包命令

      # 步骤5：通过 SSH+密码，把打包后的文件传到阿里云服务器
      - name: Deploy to Aliyun via SSH
        uses: appleboy/scp-action@master
        with:
          # 服务器信息（从 GitHub Secrets 读取）
          host: ${{ secrets.SSH_HOST }}        # 你的服务器 IP
          username: ${{ secrets.SSH_USERNAME }}  # root
          password: ${{ secrets.SSH_PASSWORD }}  # 你的 root 密码
          port: 22                             # SSH 端口，默认 22
          
          # 要传输的文件：GitHub 打包后的文件路径
          source: "docs/.vitepress/dist/*"
          
          # 传输到服务器的目标路径（宝塔里创建的 dist 文件夹）
          target: "/www/wwwroot/win.cooa.top/dist"
          
          # 上传前清空目标文件夹（避免旧文件残留）
          rm: true
          
          # 保持文件目录结构（不用改）
          strip_components: 4
          
          # 开启调试模式（方便看日志排错）
          debug: true
